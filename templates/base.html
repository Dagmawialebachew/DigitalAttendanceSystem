{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">

    <title>{% block title %}Attendance System{% endblock %}</title>
<link rel="stylesheet" href="{% static 'fontawesome/css/all.min.css' %}">
    <link rel="manifest" href="{% url 'manifest' %}">
    <link rel="apple-touch-icon" href="{% static 'icons/icon-192x192.png' %}">

<link rel="stylesheet" href="{% static 'css/app.css' %}">


    {% block extra_css %}{% endblock %}
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 dark:from-slate-900 dark:to-slate-800 min-h-screen transition-colors duration-200">

    <div class="{% if user.is_authenticated %}pb-20{% endif %} min-h-screen">
        {% block content %}{% endblock %}
    </div>

    {% if user.is_authenticated %}
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 bottom-nav-safe z-50 transition-transform duration-300 ease-in-out">
        <div class="max-w-screen-xl mx-auto px-4">
            <div class="flex justify-around items-center h-16">

                <a href="{% if user.is_teacher or user.is_admin_role %}{% url 'teacher_dashboard' %}{% else %}{% url 'student_dashboard' %}{% endif %}"
                   class="nav-item flex flex-col items-center justify-center flex-1 py-2 transition-all duration-200 hover:text-primary-600 dark:hover:text-primary-400 {% if request.resolver_match.url_name == 'teacher_dashboard' or request.resolver_match.url_name == 'student_dashboard' %}text-primary-600 dark:text-primary-400{% else %}text-slate-600 dark:text-slate-400{% endif %}">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span class="text-xs font-medium">Home</span>
                </a>

                {% if user.is_student %}
                <a href="{% url 'attendance_history' %}"
                   class="nav-item flex flex-col items-center justify-center flex-1 py-2 transition-all duration-200 hover:text-primary-600 dark:hover:text-primary-400 {% if request.resolver_match.url_name == 'attendance_history' %}text-primary-600 dark:text-primary-400{% else %}text-slate-600 dark:text-slate-400{% endif %}">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <span class="text-xs font-medium">History</span>
                </a>

                <a href="{% url 'gamification' %}"
                   class="nav-item flex flex-col items-center justify-center flex-1 py-2 transition-all duration-200 hover:text-primary-600 dark:hover:text-primary-400 {% if request.resolver_match.url_name == 'gamification' %}text-primary-600 dark:text-primary-400{% else %}text-slate-600 dark:text-slate-400{% endif %}">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-xs font-medium">Rewards</span>
                </a>
                {% else %}
                <a href="{% url 'analytics' %}"
                   class="nav-item flex flex-col items-center justify-center flex-1 py-2 transition-all duration-200 hover:text-primary-600 dark:hover:text-primary-400 {% if request.resolver_match.url_name == 'analytics' %}text-primary-600 dark:text-primary-400{% else %}text-slate-600 dark:text-slate-400{% endif %}">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="text-xs font-medium">Analytics</span>
                </a>
                {% endif %}

                <a href="{% url 'notifications' %}"
                   class="nav-item flex flex-col items-center justify-center flex-1 py-2 transition-all duration-200 hover:text-primary-600 dark:hover:text-primary-400 relative {% if request.resolver_match.url_name == 'notifications' %}text-primary-600 dark:text-primary-400{% else %}text-slate-600 dark:text-slate-400{% endif %}">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span class="text-xs font-medium">Alerts</span>
<span id="notif-badge"
      class="absolute top-1 max-md:right-[30%] right-[45%] min-w-[1rem] h-5 px-1.5 text-xs font-semibold text-white bg-red-500 rounded-full flex items-center justify-center hidden">
</span>
                </a>

                <a href="{% url 'profile' %}"
                   class="nav-item flex flex-col items-center justify-center flex-1 py-2 transition-all duration-200 hover:text-primary-600 dark:hover:text-primary-400 {% if request.resolver_match.url_name == 'profile' %}text-primary-600 dark:text-primary-400{% else %}text-slate-600 dark:text-slate-400{% endif %}">
                    <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span class="text-xs font-medium">Profile</span>
                </a>
            </div>
        </div>
    </nav>
    {% endif %}

  <button id="theme-toggle"
    class="fixed top-4 right-4 z-40 p-3 rounded-full transition-transform duration-200 shadow-lg
           bg-white/80 dark:bg-slate-700/80 hover:scale-110 border border-slate-200 dark:border-slate-600
           backdrop-blur-lg">
    <svg id="theme-icon-light" class="w-5 h-5 text-slate-800 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
    </svg>
    <svg id="theme-icon-dark" class="w-5 h-5 text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
    </svg>
</button>


    <script>
        // --- Theme Toggle Logic ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconLight = document.getElementById('theme-icon-light');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const html = document.documentElement;

        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            html.classList.add('dark');
            themeIconLight.classList.remove('hidden');
            themeIconDark.classList.add('hidden');
        } else {
            themeIconLight.classList.add('hidden');
            themeIconDark.classList.remove('hidden');
        }

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');

            themeIconLight.classList.toggle('hidden');
            themeIconDark.classList.toggle('hidden');
        });

       if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register("/sw.js")
      .then(() => console.log("✅ Service Worker registered"))
      .catch(err => console.error("❌ Service Worker registration failed:", err));
  }
        // --- Real-time Notification Badge Polling (API MUST be implemented) ---
        const notifBadge = document.getElementById('notif-badge');
        const navBar = document.getElementById('bottom-nav'); // Get the nav bar element
        const NOTIF_POLL_INTERVAL = 30000; // Poll every 30 seconds

        function fetchNotificationCount() {
            // Assumes Django has an endpoint at '/api/notifications/unread-count/' that returns { "unread_count": N }
            fetch('/api/notifications/unread-count/')
                .then(response => response.json())
                .then(data => {
                    const count = data.count || 0;
                    console.log("Unread notifications:", count);
                    if (count > 0) {
                        notifBadge.classList.remove('hidden');
                        notifBadge.textContent = count > 99 ? '99+' : count;
                    } else {
                        notifBadge.classList.add('hidden');
                    }
                })
                .catch(error => {
                    console.error("Error fetching notification count:", error);
                });
        }

        if (notifBadge) {
            fetchNotificationCount();
            setInterval(fetchNotificationCount, NOTIF_POLL_INTERVAL);
        }

        // --- Mobile UX Enhancement: Auto-hide Nav on Scroll Down ---
        let lastScrollTop = 0;
        
        if (navBar) {
             window.addEventListener('scroll', () => {
                let st = window.pageYOffset || document.documentElement.scrollTop;
                
                // Hide nav if scrolling down and past the first 100px
                if (st > lastScrollTop && st > 100){
                    navBar.classList.add('nav-hidden');
                } else {
                    // Show nav if scrolling up or near the top
                    navBar.classList.remove('nav-hidden');
                }
                
                lastScrollTop = st <= 0 ? 0 : st; 
            }, false);
        }
    </script>
    

    {% block extra_js %}{% endblock %}
</body>
</html>