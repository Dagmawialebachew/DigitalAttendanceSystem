{% extends 'base.html' %}

{% block title %}Submit Attendance{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <a href="{% url 'student_dashboard' %}" class="inline-flex items-center text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 mb-6">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to Dashboard
        </a>

        <div class="glass rounded-3xl p-8 shadow-2xl fade-in">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-700 rounded-2xl mb-4 shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white mb-2">{{ session.course.name }}</h1>
                <p class="text-slate-600 dark:text-slate-400">{{ session.course.code }}</p>
            </div>

            {% if is_valid %}
            <div id="timer-bar" class="bg-slate-200 dark:bg-slate-700 rounded-full h-2 mb-6 overflow-hidden">
                <div id="timer-progress" class="bg-gradient-to-r from-primary-500 to-primary-700 h-full transition-all duration-1000 ease-linear"></div>
            </div>

            <div id="countdown-display" class="text-center text-4xl font-bold text-primary-600 dark:text-primary-400 mb-6"></div>

            <form id="attendance-form" method="post" class="space-y-6">
                {% csrf_token %}

                <div>
                    <label for="code" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Enter Code</label>
                    <input type="text" name="code" id="code" maxlength="6" required autocomplete="off" autofocus
                           class="w-full px-6 py-4 text-center text-3xl font-mono font-bold uppercase rounded-xl border-2 border-primary-300 dark:border-primary-700 bg-white dark:bg-slate-700 text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all duration-200 tracking-widest"
                           placeholder="XXXX">
                </div>

                <button type="submit" id="submit-btn"
                        class="w-full bg-gradient-to-r from-primary-500 to-primary-700 hover:from-primary-600 hover:to-primary-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                    <svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Submit Attendance
                </button>
            </form>
            {% else %}
            <div class="text-center py-8">
                <div class="w-20 h-20 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-2">Session Expired</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-6">This attendance session has ended</p>
                <a href="{% url 'student_dashboard' %}"
                   class="inline-block bg-primary-500 hover:bg-primary-600 text-white font-semibold px-6 py-3 rounded-xl transition-colors duration-200">
                    Return to Dashboard
                </a>
            </div>
            {% endif %}

            <div id="feedback" class="hidden mt-6 p-4 rounded-xl text-center font-semibold"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if is_valid %}
<script>
    const form = document.getElementById('attendance-form');
    const codeInput = document.getElementById('code');
    const submitBtn = document.getElementById('submit-btn');
    const feedback = document.getElementById('feedback');
    const countdownDisplay = document.getElementById('countdown-display');
    const timerProgress = document.getElementById('timer-progress');

    const startTime = new Date("{{ session.start_time|date:'c' }}");
    const duration = {{ session.duration_seconds }};

    codeInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="inline-block animate-spin mr-2">⏳</span> Submitting...';

        const formData = new FormData(form);

        try {
            const response = await fetch('', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });

            const data = await response.json();

            feedback.classList.remove('hidden');

            if (data.success) {
                feedback.className = 'mt-6 p-4 rounded-xl text-center font-semibold bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 pulse-success';
                feedback.innerHTML = '✅ ' + data.message + ' (+10 points!)';

                setTimeout(() => {
                    window.location.href = "{% url 'student_dashboard' %}";
                }, 2000);
            } else {
                feedback.className = 'mt-6 p-4 rounded-xl text-center font-semibold bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300 shake';
                feedback.innerHTML = '❌ ' + data.message;
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Submit Attendance';
                codeInput.value = '';
                codeInput.focus();
            }
        } catch (error) {
            feedback.classList.remove('hidden');
            feedback.className = 'mt-6 p-4 rounded-xl text-center font-semibold bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300';
            feedback.textContent = '❌ Connection error. Please try again.';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<svg class="w-5 h-5 inline-block mr-2 -mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Submit Attendance';
        }
    });

    function updateCountdown() {
        const now = new Date();
        const elapsed = (now - startTime) / 1000;
        const remaining = Math.max(0, duration - elapsed);
        const percentage = (remaining / duration) * 100;

        timerProgress.style.width = percentage + '%';

        if (remaining > 0) {
            countdownDisplay.textContent = Math.ceil(remaining) + 's';
            requestAnimationFrame(updateCountdown);
        } else {
            countdownDisplay.textContent = 'Expired';
            countdownDisplay.className = 'text-center text-4xl font-bold text-red-600 dark:text-red-400 mb-6';
            submitBtn.disabled = true;
            submitBtn.className = 'w-full bg-slate-400 text-white font-bold py-4 px-6 rounded-xl cursor-not-allowed';
            codeInput.disabled = true;

            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    }

    updateCountdown();
</script>
{% endif %}
{% endblock %}
